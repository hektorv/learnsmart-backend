openapi: 3.0.3
info:
  title: Profile Service API
  version: 1.0.0
  description: API para gestionar el perfil, objetivos y preferencias de estudio de los usuarios.

servers:
  - url: /profile-service

security:
  - bearerAuth: []

tags:
  - name: Auth
    description: Registro de usuarios (creacion en Keycloak + perfil).
  - name: Profile
    description: Datos basicos de perfil del usuario.
  - name: Goals
    description: Objetivos de aprendizaje del usuario.
  - name: Preferences
    description: Preferencias de estudio del usuario.
  - name: Audit
    description: Trazabilidad y logs de auditoria.

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Registrar un nuevo usuario
      description: >
        Crea el usuario en el IdP (Keycloak) y un perfil inicial en el profile-service.
        Tras el registro, el cliente debe usar el flujo OIDC de Keycloak para obtener tokens.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistrationRequest'
      responses:
        '201':
          description: Usuario y perfil creados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '400':
          description: Datos invalidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Usuario ya existe (email duplicado)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles:
    post:
      tags: [Profile]
      summary: Crear perfil de usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistrationRequest'
      responses:
        '201':
          description: Perfil creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '400':
          description: Datos invalidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/me:
    get:
      tags: [Profile]
      summary: Obtener el perfil del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      responses:
        '200':
          description: Perfil del usuario autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [Profile]
      summary: Actualizar el perfil del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
      responses:
        '200':
          description: Perfil actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '400':
          description: Datos invalidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/me/progress:
    get:
      tags: [Profile]
      summary: Obtener progreso consolidado del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      responses:
        '200':
          description: Progreso del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProgressResponse'

  /profiles/me/audit-logs:
    get:
      tags: [Audit]
      summary: Obtener logs de auditoria del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: query
          name: page
          schema:
            type: integer
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Lista de logs de auditoria
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserAuditLogResponse'

  /profiles/{userId}:
    get:
      tags: [Profile]
      summary: Obtener el perfil de un usuario por ID (uso administrativo)
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/{userId}/audit:
    get:
      tags: [Audit]
      summary: Obtener audit trail de un usuario
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: page
          schema:
            type: integer
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            default: 20
        - in: query
          name: startDate
          schema:
            type: string
            format: date-time
        - in: query
          name: endDate
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Lista de logs de auditoria
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserAuditLog'

  /profiles/{userId}/goals/{goalId}/audit:
    get:
      tags: [Audit]
      summary: Obtener audit trail de un objetivo
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: page
          schema:
            type: integer
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Lista de logs de auditoria del objetivo
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserAuditLog'

  /profiles/{userId}/preferences/audit:
    get:
      tags: [Audit]
      summary: Obtener audit trail de preferencias de usuario
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: page
          schema:
            type: integer
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Lista de logs de auditoria de preferencias
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserAuditLog'

  /profiles/me/goals:
    get:
      tags: [Goals]
      summary: Listar objetivos del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      responses:
        '200':
          description: Lista de objetivos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserGoalResponse'
    post:
      tags: [Goals]
      summary: Crear un objetivo para el usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserGoalCreateRequest'
      responses:
        '201':
          description: Objetivo creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGoalResponse'

  /profiles/me/goals/{goalId}:
    put:
      tags: [Goals]
      summary: Actualizar un objetivo del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserGoalUpdateRequest'
      responses:
        '200':
          description: Objetivo actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGoalResponse'
        '404':
          description: Objetivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      tags: [Goals]
      summary: Actualizar parcialmente un objetivo del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserGoalUpdateRequest'
      responses:
        '200':
          description: Objetivo actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGoalResponse'
        '404':
          description: Objetivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags: [Goals]
      summary: Eliminar un objetivo del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Objetivo eliminado
        '404':
          description: Objetivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/me/goals/{goalId}/complete:
    post:
      tags: [Goals]
      summary: Marcar un objetivo como completado
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Objetivo marcado como completado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGoalResponse'
        '404':
          description: Objetivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/me/goals/{goalId}/progress:
    patch:
      tags: [Goals]
      summary: Actualizar porcentaje de progreso de un objetivo
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: goalId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                percentage:
                  type: integer
                  minimum: 0
                  maximum: 100
      responses:
        '200':
          description: Progreso actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGoalResponse'
        '404':
          description: Objetivo no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /profiles/me/goals/status/{status}:
    get:
      tags: [Goals]
      summary: Listar objetivos por estado
      parameters:
        - $ref: '#/components/parameters/XUserId'
        - in: path
          name: status
          required: true
          schema:
            type: string
            enum: [ACTIVE, COMPLETED, PAUSED, ABANDONED]
      responses:
        '200':
          description: Lista de objetivos filtrados por estado
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserGoalResponse'

  /profiles/me/preferences:
    get:
      tags: [Preferences]
      summary: Obtener las preferencias de estudio del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      responses:
        '200':
          description: Preferencias del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserStudyPreferencesResponse'
        '404':
          description: Preferencias no configuradas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [Preferences]
      summary: Crear o actualizar las preferencias de estudio del usuario actual
      parameters:
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserStudyPreferencesUpdate'
      responses:
        '200':
          description: Preferencias actualizadas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserStudyPreferencesResponse'
        '400':
          description: Datos invalidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    XUserId:
      in: header
      name: X-User-Id
      required: false
      schema:
        type: string
      description: ID del usuario (propagado por el Gateway o para pruebas)

  schemas:
    UserRegistrationRequest:
      type: object
      required:
        - email
        - password
        - displayName
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        displayName:
          type: string
          maxLength: 120
        locale:
          type: string
          example: es-ES
        timezone:
          type: string
          example: Europe/Madrid
        additionalAttributes:
          type: object
          additionalProperties: true

    UserProfileResponse:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        authUserId:
          type: string
        email:
          type: string
          format: email
        displayName:
          type: string
        birthYear:
          type: integer
          format: int32
        locale:
          type: string
        timezone:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserProfileUpdateRequest:
      type: object
      properties:
        displayName:
          type: string
        birthYear:
          type: integer
          format: int32
        locale:
          type: string
        timezone:
          type: string

    UserGoalCreateRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
        description:
          type: string
        domainId:
          type: string
          format: uuid
        skillId:
          type: string
          format: uuid
        targetLevel:
          type: string
        dueDate:
          type: string
          format: date
        intensity:
          type: string
          enum: [minimum, standard, aggressive]

    UserGoalUpdateRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        domainId:
          type: string
          format: uuid
        targetLevel:
          type: string
        dueDate:
          type: string
          format: date
        intensity:
          type: string
          enum: [minimum, standard, aggressive]
        isActive:
          type: boolean
        status:
          type: string
          enum: [ACTIVE, COMPLETED, PAUSED, ABANDONED]
        progressPercentage:
          type: integer
          minimum: 0
          maximum: 100

    UserGoalResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        domainId:
          type: string
          format: uuid
        skillId:
          type: string
          format: uuid
        targetLevel:
          type: string
        dueDate:
          type: string
          format: date
        intensity:
          type: string
          enum: [minimum, standard, aggressive]
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        completionPercentage:
          type: integer
        status:
          type: string
          enum: [ACTIVE, COMPLETED, PAUSED, ABANDONED]

    UserStudyPreferencesResponse:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        hoursPerWeek:
          type: number
          format: double
        preferredDays:
          type: array
          items:
            type: string
        preferredSessionMinutes:
          type: integer
        notificationsEnabled:
          type: boolean

    UserStudyPreferencesUpdate:
      type: object
      properties:
        hoursPerWeek:
          type: number
          format: double
        preferredDays:
          type: array
          items:
            type: string
        preferredSessionMinutes:
          type: integer
        notificationsEnabled:
          type: boolean

    UserAuditLogResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        performedBy:
          type: string
          format: uuid
        entityType:
          type: string
        entityId:
          type: string
          format: uuid
        action:
          type: string
        fieldName:
          type: string
        oldValue:
          type: string
        newValue:
          type: string
        timestamp:
          type: string
          format: date-time
        ipAddress:
          type: string
        userAgent:
          type: string

    UserAuditLog:
      type: object
      description: Audit log entity (returned by admin audit endpoints)
      properties:
        id:
          type: string
          format: uuid
        performedBy:
          type: string
          format: uuid
        entityType:
          type: string
        entityId:
          type: string
          format: uuid
        action:
          type: string
        fieldName:
          type: string
        oldValue:
          type: string
        newValue:
          type: string
        timestamp:
          type: string
          format: date-time
        ipAddress:
          type: string
        userAgent:
          type: string

    UserProgressResponse:
      type: object
      properties:
        profile:
          $ref: '#/components/schemas/ProfileInfo'
        goals:
          type: array
          items:
            $ref: '#/components/schemas/GoalProgress'
        currentPlan:
          $ref: '#/components/schemas/PlanProgress'
        skillsInProgress:
          type: array
          items:
            $ref: '#/components/schemas/SkillMasteryShort'
        activity:
          $ref: '#/components/schemas/ActivitySummary'

    ProfileInfo:
      type: object
      properties:
        userId:
          type: string
        displayName:
          type: string

    GoalProgress:
      type: object
      properties:
        goalId:
          type: string
          format: uuid
        title:
          type: string
        percentage:
          type: number
          format: double

    PlanProgress:
      type: object
      properties:
        planId:
          type: string
          format: uuid
        goalId:
          type: string
        status:
          type: string
        completedModules:
          type: integer
        totalModules:
          type: integer
        overallPercentage:
          type: number
          format: double

    SkillMasteryShort:
      type: object
      properties:
        skillId:
          type: string
          format: uuid
        skillName:
          type: string
        mastery:
          type: number
          format: double

    ActivitySummary:
      type: object
      properties:
        totalHours:
          type: number
          format: double
        currentStreak:
          type: integer

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
